<div 
  {% if is_oob %}hx-swap-oob="true"{% endif %} 
  id="table" 
  class="mt-4 overflow-x-auto w-full"
>

  <table class="table w-full">
    <thead>
      <tr>
        <th>
          <label>
            <input
              type="checkbox"
              id="select-all"
              class="checkbox checkbox-xs md:checkbox-sm checkbox-secondary/25"
              onclick="toggleSelectAll(this)"
            />
          </label>
        </th>
        <th>Amount</th>
        <th>Exchange Rate</th>
        <th class="w-24">Converted Amount</th>
        <th class="text-center">Type</th>
        <th class="text-center">Status</th>
        <th>Date</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for entry in entries %}
        {% include "entries/partials/row.html" with entry=entry %}
      {% empty %}
        <tr>
          <td colspan="8" class="text-center p-4 text-sm text-neutral">
            No Expense Entries found
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_paginated %}
    {% include "components/pagination.html" with request=request %}
  {% endif %}
  
  <script>
    
    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('#entry-layout-container .bulk-checkbox'); // Scope to #entry-layout-container
      const checked = document.querySelectorAll('#entry-layout-container .bulk-checkbox:checked');
      const button = document.getElementById('bulk-select-button'); // This is OUTSIDE the #entry-layout-container
      const countSpan = document.getElementById('selected-count'); // This is OUTSIDE the #entry-layout-container
      const selectAll = document.getElementById('select-all'); // This checkbox is INSIDE the #entry-layout-container

      const count = checked.length;

      // Update button visibility and text (the button and count span are persistent)
      if (button) { // defensive check in case the button isn't immediately available
        if (count > 0) {
          button.classList.remove('hidden');
          if (countSpan) countSpan.textContent = count;
        } else {
          button.classList.add('hidden');
          if (countSpan) countSpan.textContent = '0'; // Explicitly reset count
        }
      }

      // Update "Select All" checkbox (this checkbox is swapped with the table)
      if (selectAll) { // defensive check
        if (count === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        } else if (count > 0 && count === checkboxes.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        }
      }
    }
  
    function toggleSelectAll(source) {
      const checkboxes = document.querySelectorAll('#entry-layout-container .bulk-checkbox');
      const isChecked = source.checked;
      checkboxes.forEach(cb => {
        cb.checked = isChecked;
      });
      updateBulkActions();
    }
  
    function clearSelection() {
      document.querySelectorAll('#entry-layout-container .bulk-checkbox:checked').forEach(cb => {
        cb.checked = false;
      });
      updateBulkActions();
    }

    // --- Initialization logic to run every time this script is loaded (i.e., after a swap) ---
    (function() {
      const button = document.getElementById('bulk-select-button');
      if (button) {
        button.classList.add('hidden');
        const countSpan = document.getElementById('selected-count');
        if (countSpan) countSpan.textContent = '0';
      }

      const selectAll = document.getElementById('select-all');
      if (selectAll) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }

      const checkboxes = document.querySelectorAll('#entry-layout-container .bulk-checkbox');
      checkboxes.forEach(cb => {
        cb.removeEventListener('change', updateBulkActions);
        cb.addEventListener('change', updateBulkActions);
      });
      // After re-attaching listeners, update the state based on the new (initially unchecked) checkboxes
      updateBulkActions();
    })(); // Execute the IIFE immediately

  </script>
</div>